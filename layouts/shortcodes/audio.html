{{ $src := .Get "src" }}

{{ $bookRoot := .Page.CurrentSection }}

{{ if eq .Page.Section "books" }}
  {{ range .Page.Ancestors }}
    {{ if and (eq .Section "books") (ne .RelPermalink "/books/") }}
      {{ $bookRoot = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $cleanRoot := strings.TrimSuffix "/" $bookRoot.RelPermalink }}
{{ $filePath := printf "%s/%s" $cleanRoot $src }}

{{ $encoded := urlquery $filePath }}

{{ $url := printf "https://xiangcaoshan.netlify.app/.netlify/functions/audio?file=%s" $encoded }}

<audio controls preload="metadata">
  <source src="{{ $url }}" type="audio/mpeg">
</audio>
